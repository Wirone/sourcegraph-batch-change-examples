name: pin-docker-images
description: Pin Docker images using the `:latest` tag to a specific image digest.
on:
  # Find all repositories that contain Dockerfiles with a `:latest` tag in a base image.
  - repositoriesMatchingQuery: ^FROM (\w+\/)?\w+:latest($|\s) file:Dockerfile patternType:regexp repo:sourcegraph-testing
# In each repository:
steps:
  # Find all Dockerfiles and pin their FROM image tags:
  - run: |
      find . -name Dockerfile -type f |\
      xargs dockerlint -w
    container: sourcegraph/dockerlint-run:latest
# Describe the changeset (e.g., GitHub pull request) you want for each repository.
changesetTemplate:
  title: Pin Docker `:latest` image tags to digest
  body: >
    The `:latest` tag changes, so future pulls of this image may retrieve a different image with different (and possibly erroneous, unexpected, or dangerous) behavior. Pin the image to an [image digest](https://docs.docker.com/engine/reference/commandline/pull/#pull-an-image-by-digest-immutable-identifier) for deterministic behavior. *See also: [Hadolint error DL3007](https://github.com/hadolint/hadolint/wiki/DL3007).*
  branch: thorsten/pin-docker-images
  commit:
    message: Pin Docker `:latest` image tags to digest
  published: false
